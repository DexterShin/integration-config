- builder:
    name: browsertest-website
    builders:
      - shell: |
          # set up environment variables
          export BROWSER={browser}
          export HEADLESS=true
          export MEDIAWIKI_PASSWORD_VARIABLE={mediawiki_password_variable}
          export MEDIAWIKI_URL=http://{mediawiki_url}/wiki/
          export MEDIAWIKI_USER={mediawiki_user}
          export PLATFORM='{platform}'
          export SCREENSHOT_FAILURES=true
          export SCREENSHOT_FAILURES_PATH="$WORKSPACE/log"
          export VERSION={version}

          if [ $BROWSER == "internet_explorer" ]
          then
            BROWSER_TAG=${{BROWSER}}_$VERSION
          else
            BROWSER_TAG=$BROWSER
          fi

          # Shared cache of gems to avoid hitting rubygems all the time
          # See https://github.com/bundler/bundler/issues/2856
          export GEM_HOME="$WORKSPACE/../gems"

          # install ruby dependencies
          mkdir -p vendor
          gem1.9.3 install --env-shebang -i vendor bundler --no-ri --no-rdoc
          # Prepare some paths lookup
          export GEM_PATH="`pwd`/vendor"

          cd {folder}/browser/
          "$WORKSPACE"/vendor/bin/bundle install --verbose

          # run tests
          "$WORKSPACE"/vendor/bin/bundle exec cucumber \
            --backtrace \
            --color \
            --verbose \
            --format pretty \
            --format Cucumber::Formatter::Sauce \
            --out "$WORKSPACE/log/junit" \
            --tags @{mediawiki_url} \
            --tags @$BROWSER_TAG \
            || (echo -e "\nJob has failed (exit code: $?)."; false)

- publisher:
    name: browsertests-irc
    publishers:
      - ircbot:
          strategy: all
          notify-start: false
          notify-committers: false
          notify-culprits: false
          notify-upstream: false
          notify-fixers: false
          message-type: summary-scm
          matrix-notifier: only-configurations
          channels:
              - name: '#wikimedia-qa'
                notify-only: true
