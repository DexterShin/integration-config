# Git comes with a whitespace checking system that will fail whenever the diff
# contains trailing spaces.  We can use that to easily lint whitespaces in
# submitted changes.

# Lint whitespace in directory {dir}. Usefull when the Git repository has
# been fetched out in some subdirtory of the Workspace. Example:
#
#  builder:
#    - lint-whitespaces-in:
#       dir: "$WORKSPACE/extensions/Foobar"
#
- builder:
    name: lint-whitespaces-in
    builders:
        - shell: "git --work-tree=\"{dir}\" diff --color --check HEAD^..HEAD"

# Lint whitespaces under $WORKSPACE. This is most probably the one you
# want to use. Example:
#
# builder:
#  - lint-whitespaces
#
- builder:
    name: lint-whitespaces
    builders:
     - lint-whitespaces-in:
        dir: '$WORKSPACE'

# `get-mw-core` injects mediawiki/core@{requested branch} in $WORKSPACE
# This should be used when testing extensions
#
# The aim is to get the very latest MediaWiki core version into the extension
# workspace without having to fully clone the repository. We cant use git
# archive with Gerrit so we get the code from the local replicated clone.
- builder:
    name: get-mw-core
    builders:
        - shell: |
            #!/bin/bash -xe
            # Snapshot `remotes/origin/{branch}` in the job workspace
            git archive --remote=/var/lib/git/mediawiki/core.git {branch} \
                | (cd "$WORKSPACE" && tar xf -)

- builder:
    name: jshint-in
    # Use `cd` because jshint reads .jshintrc/.jshitignore from PWD
    builders:
     - shell: |
        #!/bin/bash -e
        cd "{dir}"
        /var/lib/jenkins/bin/jshint . \
            --checkstyle-reporter > "$WORKSPACE/checkstyle-jshint.xml" \
            && HAS_ERROR=0 || HAS_ERROR=1
        echo
        echo 'Check the "Checkstyle Warnings" link on the left for JSHint report.'
        echo
        exit $HAS_ERROR

- builder:
    name: jshint
    builders:
     - jshint-in:
        dir: '$WORKSPACE'

# Has to be named something other than 'checkstyle' or python will
# go into infinite recursion when generating the jobs.
# JSHint considers all errors to be "high" priority except those
# suppressed via options in jshintrc (those become "normal").
# So we need to make sure we don't count warnings that are intentionally
# ignored by style or convention of the repository.
- publisher:
    name: checkstyle-xml
    publishers:
     - checkstyle:
        pattern: 'checkstyle-*.xml'
        canRunOnFailed: true
        healthy: 0
        unHealthy: 100
        healthThreshold: 'high'
        thresholds:
            unstable:
                totalHigh: 10
            failed:
                totalHigh: 1

- builder:
    name: mw-get-extensions
    builders:
        - shell: "/var/lib/jenkins/tools/fetch-mw-ext {dependencies}"

# Inject in LocalSettings.php some code to automatically load
# installed extensions.
- builder:
    name: mw-configure-extensions
    builders:
        - shell: |
            #!/bin/bash -xe
            echo "require_once( '/var/lib/jenkins/tools/extensions-loader.php' );" \
                >> "$WORKSPACE/LocalSettings.php"

- builder:
    name: mw-run-update-script
    builders:
        - shell: 'php "$WORKSPACE/maintenance/update.php" --quick'

- builder:
    name: mw-install-sqlite
    builders:
      - ant:
          targets: "installdb-sqlite"
          buildfile: "/var/lib/jenkins/jobs/_shared/build.xml"

- builder:
    name: mw-phpunit
    builders:
      - shell: 'php tests/phpunit/phpunit.php --log-junit junit-phpunit.xml'

- builder:
    name: mw-phpunit-ext
    builders:
      - shell: 'php tests/phpunit/phpunit.php --log-junit junit-phpunit-ext.xml -- extensions/{extension}'

- builder:
    name: mw-phpunit-allexts
    builders:
# --testsuite is not yet available on gallium :(
#      - shell: 'php tests/phpunit/phpunit.php --log-junit junit-phpunit-allexts.xml --testsuite extensions'
      - shell: 'php tests/phpunit/phpunit.php --log-junit junit-phpunit-allexts.xml -- extensions'

# Python pep8 builder - copied from OpenStack project
- builder:
    name: pep8
    builders:
     - shell: "set -o pipefail ; pep8 . | tee pep8.txt ; set +o pipefail"

# Python pep8 publisher - copied from OpenStack project
- publisher:
    name: pep8
    publishers:
     - violations:
        pep8:
            min: 0
            max: 1
            unstable: 1
            pattern: '**/pep8.txt'

- builder:
    name: pyflakes
    builders:
     - shell: "pyflakes"

- builder:
    name: php-lint
    builders:
     - ant:
        targets: 'php-lint'
        buildfile: '/var/lib/jenkins/jobs/_shared/build.xml'

# run phpcs on any .php and .inc files in the workspace
- builder:
    name: phpcs
    builders:
     - shell: |
        phpcs -v -s . \
         --standard=/var/lib/jenkins/tools/mwcodesniffer/MediaWiki \
         --extensions=php,inc \
         --ignore=languages/messages/Messages \
         --report-checkstyle=checkstyle-phpcs.xml \
         --report-full

# run phpcs on files changed in HEAD. Ignores:
#  - the mw/core language files
#  - any .js files
- builder:
    name: phpcs-HEAD
    builders:
     - shell: |
        # Get a list of files changed in HEAD, skipping deleted files and css
        # and js files which are interpreted by phpcs but we do not want it to
        # handle.  Piped to 'echo -n' to ignore egrep exit code.
        PHPCS_FILES=$(git diff --name-status HEAD^ \
             | egrep -v '^D' | cut -f2 \
             | egrep '\.(php5?|inc|sample)$' \
             || echo -n
             )
        # No file? No point in proceeding any further (bug 44567)
        if [ -z "$PHPCS_FILES" ]; then
            echo "Skipping phpcs: no file remaining to process"
            exit 0
        fi

        phpcs -v -s $PHPCS_FILES \
         --standard=/var/lib/jenkins/tools/mwcodesniffer/MediaWiki \
         --ignore=languages/messages/Messages \
         --report-checkstyle=checkstyle-phpcs.xml \
         --report-full

- publisher:
    name: phpcs
    publishers:
     - violations:
        checkstyle:
            min: 0
            max: 1
            unstable: 1
            pattern: '**/checkstyle-phpcs.xml'


- builder:
    name: php-extension
    builders:
     - shell: |
        phpize
        ./configure
        make
        make test

# Fetch an extension at the root of the workspace
#
# Example usage:
# scm:
#  - git-mwext-in-root:
#    ext-name: '{ext-name}'
- scm:
    name: git-mwext-in-root
    scm:
     - git:
        url: '/var/lib/zuul/git/mediawiki/extensions/{ext-name}'
        branches:
         - '$ZUUL_BRANCH'
        refspec: '$ZUUL_REF'
