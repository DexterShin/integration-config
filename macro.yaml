- builder:
    name: browsertest-website
    builders:
      - shell: |
          # set up environment variables
          export BROWSER={browser}
          export HEADLESS={headless}
          export MEDIAWIKI_API_URL=http://{mediawiki_url}/w/api.php
          export MEDIAWIKI_PASSWORD_VARIABLE={mediawiki_password_variable}
          export MEDIAWIKI_URL=http://{mediawiki_url}/wiki/
          export MEDIAWIKI_USER={mediawiki_user}
          export PLATFORM='{platform}'
          export SCREENSHOT_FAILURES=true
          export SCREENSHOT_FAILURES_PATH="$WORKSPACE/log"

          # We only care about one version of our browser and do not need a job
          # per version.  Thus the versions to use are hardcoded there.
          #
          # VERSION is used for SauceLabs
          #
          case "$BROWSER" in
            'firefox')
                export VERSION=27
                ;;
            'chrome')
                # Empty version will get us the latest one
                export VERSION=''
                ;;
            *)
                echo "Browser '$BROWSER' unsupported. Can not determine version"
                exit 1
                ;;
          esac
          echo "Using browser: $BROWSER at version $VERSION"

          if [ $BROWSER == "internet_explorer" ]
          then
            BROWSER_TAG=${{BROWSER}}_$VERSION
          else
            BROWSER_TAG=$BROWSER
          fi

          # Shared cache of gems to avoid hitting rubygems all the time
          # See https://github.com/bundler/bundler/issues/2856
          export GEM_HOME="$WORKSPACE/../gems"

          # Attempt to figure out MediaWiki branch being used and fetch it out
          # if the extension has the same branch
          MEDIAWIKI_GIT_BRANCH=$(/srv/deployment/integration/slave-scripts/bin/mw-api-siteinfo.py "$MEDIAWIKI_API_URL" git_branch)


          git checkout -f "origin/$MEDIAWIKI_GIT_BRANCH" || {{
              echo "origin/$MEDIAWIKI_GIT_BRANCH branch does not exist."
              echo "Fallbacking to master branch..."
              MEDIAWIKI_GIT_BRANCH='master'
              git checkout -f origin/$MEDIAWIKI_GIT_BRANCH
          }}
          git reset --hard "origin/$MEDIAWIKI_GIT_BRANCH"
          git clean -x -q -d -f

          # install ruby dependencies
          mkdir -p vendor
          gem1.9.3 install --env-shebang -i vendor bundler --no-ri --no-rdoc
          # Prepare some paths lookup
          export GEM_PATH="`pwd`/vendor"

          cd {folder}/browser/
          "$WORKSPACE"/vendor/bin/bundle install --verbose

          # run tests
          "$WORKSPACE"/vendor/bin/bundle exec cucumber \
            --backtrace \
            --color \
            --verbose \
            --format pretty \
            --format Cucumber::Formatter::Sauce \
            --out "$WORKSPACE/log/junit" \
            --tags @{mediawiki_url} \
            --tags @$BROWSER_TAG \
            || (echo -e "\nJob has failed (exit code: $?)."; false)

- publisher:
    name: browsertests-irc
    publishers:
      - ircbot:
          strategy: all
          notify-start: false
          notify-committers: false
          notify-culprits: false
          notify-upstream: false
          notify-fixers: false
          message-type: summary
          matrix-notifier: only-configurations
          channels:
              - name: '#wikimedia-qa'
                notify-only: true
