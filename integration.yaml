# Jobs for integration/*

# Job that update the file hierarchy maintained by CI.
#
# As of July 2013 the two main entry points are:
# - integration.wikimedia.org
# - doc.wikimedia.org
- job-template:
    name: 'integration-docroot-deploy'
    node: gallium
    defaults: global
    triggers:
     - zuul
    builders:
     - shell: |
        #!/bin/bash -e
        cd /srv/
        git remote update
        git checkout $ZUUL_COMMIT
        echo "`date -R`> $ZUUL_COMMIT" >> /srv/jenkins-autodeploy

# Pass zuul-config.git:layout.yaml to zuul-server layout validation
# Requires zuul to be installed on the Jenkins host.
- job-template:
    name: 'integration-zuul-layoutvalidation'
    node: gallium  # it is running Zuul
    defaults: use-zuul
    triggers:
     - zuul
    builders:
     - shell: |
        # FIXME change path whenever we have zuul packaged.
        /usr/local/bin/zuul-server -c /etc/zuul/public.conf -t -l "$WORKSPACE"/layout.yaml

# Job for Zuul configuration validation
# Make sure the Zuul config is passed and show a different with the previous
# config.
- job-template:
    name: 'integration-zuul-layoutdiff'
    node: gallium  # it is running Zuul
    defaults: use-zuul
    triggers:
     - zuul
    builders:
     - shell: |
        set +e
        # FIXME change path whenever we have zuul packaged.
        /usr/local/bin/zuul-server -c /etc/zuul/public.conf -t -l "$WORKSPACE"/layout.yaml 2>current.txt
        git checkout HEAD^
        /usr/local/bin/zuul-server -c /etc/zuul/public.conf -t -l "$WORKSPACE"/layout.yaml 2>before.txt
        colordiff -u before.txt current.txt

# Job to check JJB config
- job-template:
    name: 'integration-jjb-config-test'
    defaults: use-zuul
    triggers:
     - zuul
    scm:
        - git:
            url: 'https://gerrit.wikimedia.org/r/p/integration/jenkins-job-builder.git'
            branches:
                - master
        - git:
            url: '/srv/ssd/zuul/git/integration/jenkins-job-builder-config'
            refspec: '$ZUUL_REF'
            name: 'origin'
            disable-submodules: true
            basedir: config
    builders:
     - shell: |
        set +e
        http_proxy=nowhere python setup.py develop --user
        mkdir output/
        ~/.local/bin/jenkins-jobs test config/ -o output/

- project:
    name: 'integration-docroot'
    jobs:
     - 'integration-docroot-deploy'
     - '{name}-phplint'
     - '{name}-jslint'

- project:
    name: 'integration-zuul-config'
    jobs:
     - 'integration-zuul-layoutdiff'
     - 'integration-zuul-layoutvalidation'
     - '{name}-yamllint'

- project:
    name: 'integration-jjb-config'
    jobs:
     - '{name}-yamllint'
     - 'integration-jjb-config-test'

- project:
    name: 'integration-jenkins'
    jobs:
     - '{name}-pep8'
     - '{name}-pyflakes'
