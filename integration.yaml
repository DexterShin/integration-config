- job-template:
    name: 'integration-docroot-deploy'
    node: master  # FIXME move to slave 'gallium'
    defaults: global
    triggers:
     - zuul
    builders:
     - shell: |
        #!/bin/bash -e
        cd /srv/
        git remote update
        git checkout $ZUUL_COMMIT
        echo "`date -R`> $ZUUL_COMMIT" >> /srv/jenkins-autodeploy

# Pass zuul-config.git:layout.yaml to zuul-server layout validation
# Requires zuul to be installed on the Jenkins host.
- job-template:
    name: 'integration-zuul-layoutvalidation'
    node: gallium  # it is running Zuul
    defaults: use-zuul
    triggers:
     - zuul
    builders:
     - shell: |
        # FIXME change path whenever we have zuul packaged.
        /usr/local/bin/zuul-server -c /etc/zuul/public.conf -t -l "$WORKSPACE"/layout.yaml

- job-template:
    name: 'integration-zuul-layoutdiff'
    node: gallium  # it is running Zuul
    defaults: use-zuul
    triggers:
     - zuul
    builders:
     - shell: |
        set +e
        # FIXME change path whenever we have zuul packaged.
        /usr/local/bin/zuul-server -c /etc/zuul/public.conf -t -l "$WORKSPACE"/layout.yaml 2>current.txt
        git checkout HEAD^
        /usr/local/bin/zuul-server -c /etc/zuul/public.conf -t -l "$WORKSPACE"/layout.yaml 2>before.txt
        colordiff -u before.txt current.txt

- project:
    name: 'integration-docroot'
    gerrit-name: 'integration/docroot'
    jobs:
     - 'integration-docroot-deploy'
     - '{name}-phplint'
     - '{name}-jslint'

- project:
    name: 'integration-zuul-config'
    gerrit-name: 'integration/zuul-config'
    jobs:
     - 'integration-zuul-layoutdiff'
     - 'integration-zuul-layoutvalidation'
     - '{name}-yamllint'

- project:
    name: 'integration-jjb-config'
    gerrit-name: 'integration/jenkins-job-builder-config'
    jobs:
     - '{name}-yamllint'

- project:
    name: 'integration-jenkins'
    gerrit-name: 'integration/jenkins'
    jobs:
     - '{name}-pep8'
     - '{name}-pyflakes'
