- builder:
    name: parsoid-parsertests-run
    builders:
        - shell: 'git checkout $ZUUL_COMMIT'
        - shell: |
            cd js/tests
            NODE_PATH=$NODE_PATH:../../contrib/node_modules
            node parserTests --xml --no-color --wt2html --wt2wt --html2html --selser --changesin selser.changes.json > results.xml

- builder:
    name: parsoid-parsertests-run-wrapper
    builders:
        - trigger-builds:
            - project: parsoid-parsertests-run
              current-parameters: true
              predefined-parameters:
                ZUUL_COMMIT={triggeredCommit}
              block: true

        - copyartifact:
            project: parsoid-parsertests-run
            which-build: permalink
            permalink: last
            filter: '**/results.xml'
            flatten: true

- job-template:
    name: parsoid-parsertests-run
    node: master  # FIXME move to slave 'gallium'
    defaults:
        use-zuul
    triggers:
        - zuul
    scm:
        - git:
            url: '/srv/ssd/zuul/git/mediawiki/extensions/Parsoid'
            refspec: '$ZUUL_REF'
            name: 'origin'
            disable-submodules: true
        - git:
            url: 'https://gerrit.wikimedia.org/r/p/mediawiki/extensions/Parsoid/js/contrib.git'
            branches:
                - master
            basedir: contrib
    builders:
        - parsoid-parsertests-run
    publishers:
        - archive:
            artifacts: '**/results.xml'
        - fingerprint:
            files: '**/results.xml'

- job-template:
    name: parsoid-parsertests
    node: master  # FIXME move to slave 'gallium'
    triggers:
        - zuul
    builders:
        # Run tests on prior commit (note the caret (^) character)
        - parsoid-parsertests-run-wrapper:
            triggeredCommit: "$ZUUL_COMMIT^"

        - shell: 'mv results.xml oldresults.xml'

        # Run tests on current commit
        - parsoid-parsertests-run-wrapper:
            triggeredCommit: "$ZUUL_COMMIT"

        # Use junitdiff tool to diff the two results
        - shell: 'node /var/lib/jenkins/tools/junitdiff/junitdiff oldresults.xml results.xml > diff.xml'

    publishers:
        - xunit:
            types:
                - junit:
                    pattern: diff.xml
            thresholdmode: 'number'
            thresholds:
                - failed:
                    failurenew: '0'

- job-template:
    name: parsoid-regressions
    node: master  # FIXME move to slave 'gallium'
    defaults:
        use-zuul
    triggers:
        - zuul
    builders:
        - parsoid-parsertests-run
    publishers:
        - xunit:
            types:
                - junit:
                    pattern: results.xml
            thresholdmode: 'number'
            thresholds:
                - failed:
                    failurenew: '1'

#- job-template:
#    name: parsoid-server-sanity-check
#    defaults:
#        use-zuul
#    triggers:
#        - zuul
#    scm:
#        - git:
#            url: '/srv/ssd/zuul/git/mediawiki/extensions/Parsoid'
#            refspec: '$ZUUL_REF'
#            name: 'origin'
#            disable-submodules: true
#        - git:
#            url: 'https://gerrit.wikimedia.org/r/p/mediawiki/extensions/Parsoid/js/contrib.git'
#            branches:
#                - master
#            basedir: contrib
#    builders:
#        - shell: |
#            # If any of these commands fail, something is wrong
#            set -e
#            cd js/api
#            NODE_PATH=$NODE_PATH:../../contrib/node_modules
#            # Build a unique string so we can kill the process later
#            UNIQUESTRING="parsoidserver-$ZUUL_UUID$ZUUL_COMMIT"
#            daemon --inherit --name=$UNIQUESTRING node server.js
#            # Wait for the server to start up
#            sleep 5
#            cd ../..
#            # Pull the standard test article
#            curl localhost:8000/fr/Barack_Obama -D headers.html > output.html
#            # Kill that process we started
#            daemon --stop --name=$UNIQUESTRING
#            # Make sure the response from the server was a 200 OK.
#            grep "^HTTP.*200 OK" headers.txt

- job-template:
    name: parsoid-parse-tool-check
    node: master  # FIXME move to slave 'gallium'
    wrappers:
        - timeout:
            timeout: 5
            fail: true
    defaults:
        use-zuul
    triggers:
        - zuul
    scm:
        - git:
            url: '/srv/ssd/zuul/git/mediawiki/extensions/Parsoid'
            refspec: '$ZUUL_REF'
            name: 'origin'
            disable-submodules: true
        - git:
            url: 'https://gerrit.wikimedia.org/r/p/mediawiki/extensions/Parsoid/js/contrib.git'
            branches:
                - master
            basedir: contrib
    builders:
        - shell: |
            # If any of these commands fail, something is wrong
            set -e
            cd js/tests
            NODE_PATH=$NODE_PATH:../../contrib/node_modules
            echo "Foo" | node parse.js --wt2html
            echo "Foo" | node parse.js --wt2wt
            echo "Foo" | node parse.js --html2wt
            echo "Foo" | node parse.js --html2html

- job-template:
    name: parsoid-roundtrip-test-check
    node: master  # FIXME move to slave 'gallium'
    wrappers:
        - timeout:
            timeout: 5
            fail: true
    defaults:
        use-zuul
    triggers:
        - zuul
    scm:
        - git:
            url: '/srv/ssd/zuul/git/mediawiki/extensions/Parsoid'
            refspec: '$ZUUL_REF'
            name: 'origin'
            disable-submodules: true
        - git:
            url: 'https://gerrit.wikimedia.org/r/p/mediawiki/extensions/Parsoid/js/contrib.git'
            branches:
                - master
            basedir: contrib
    builders:
        - shell: |
            # If any of these commands fail, something is wrong
            set -e
            cd js/tests
            NODE_PATH=$NODE_PATH:../../contrib/node_modules
            node roundtrip-test.js "Barack Obama"
            node roundtrip-test.js --prefix fr "Chope"
            node roundtrip-test.js --xml "Parkour"

- job-template:
    name: parsoid-parsertests-run-harder
    node: master  # FIXME move to slave 'gallium'
    wrappers:
        - timeout:
            timeout: 10
            fail: true
    defaults:
        use-zuul
    triggers:
        - zuul
    scm:
        - git:
            url: '/srv/ssd/zuul/git/mediawiki/extensions/Parsoid'
            refspec: '$ZUUL_REF'
            name: 'origin'
            disable-submodules: true
        - git:
            url: 'https://gerrit.wikimedia.org/r/p/mediawiki/extensions/Parsoid/js/contrib.git'
            branches:
                - master
            basedir: contrib
    builders:
        - shell: |
            # If any of these commands fail, something is wrong
            set -e
            cd js/tests
            NODE_PATH=$NODE_PATH:../../contrib/node_modules
            node parserTests --wt2html --wt2wt --html2wt --html2html --selser --changesin selser.changes.json --no-color --quiet --blacklist

- project:
    name: parsoid
    gerrit-name: mediawiki/extensions/Parsoid
    jobs:
        - parsoid-parsertests
        - parsoid-parsertests-run
        - parsoid-regressions
        - parsoid-server-sanity-check
        - parsoid-parse-tool-check
        - parsoid-roundtrip-test-check
        - parsoid-parsertests-run-harder
