- job-template:
    name: 'operations-puppet-validate'
    defaults: use-zuul

    triggers:
     - zuul

    builders:
     - shell: "/bin/sed -i 's%import \"../private%#import \"../private%' manifests/base.pp"

    # Run rake validate if and only if rakefile has NOT been altered
    # by the submitted patchset.
     - shell: |
        #!/bin/bash -e

        # Zuul merge changes in the branch which is then known is the
        # job workspace as origin/branch. So we have to look up the sha1
        # of the original branch by querying the Zuul maintained repo
        ORIG_HEAD=`git --git-dir=/srv/ssd/zuul/git/operations/puppet/.git rev-parse "origin/$ZUUL_BRANCH"`
        echo "Original HEAD origin/$ZUUL_BRANCH points to $ORIG_HEAD"

        echo "Finding out whether the rakefile has been altered.."
        (   # exit 0 if rakefile got changed
            git diff --name-only "$ORIG_HEAD"..HEAD |grep rakefile>/dev/null
        ) && (
            echo "SKIPPING puppet validation: rakefile has been changed"
        ) || (
            rake --rakefile rakefile validate
        )

# Run pep8 per file so that individual puppet dirs
#  can specify their own .pep8 rules
- job-template:
    name: 'operations-puppet-pep8'
    node: hasSlaveScripts
    defaults: use-zuul

    triggers:
     - zuul

    builders:
      # Requires Jenkins slave scripts
      - shell: |
         set -o pipefail
         "$JENKINS_HOME"/tools/puppet_pep8.py . | tee pep8.txt
         set +o pipefail

    publishers:
     - pep8

# Documentation for our puppet repository
- job-template:
    name: 'operations-puppet-doc'
    defaults: use-zuul
    triggers:
     - zuul
    workspace: '/srv/org/wikimedia/doc/puppetsource'
    builders:
     - shell: |
        #!/bin/bash -e
        /usr/bin/puppet doc \
            --mode rdoc \
            --outputdir /srv/org/wikimedia/doc/puppet \
            --modulepath "$WORKSPACE/modules" \
            --manifestdir "$WORKSPACE/manifests"

# Find out common typos in any files of ops/puppet
- job-template:
    name: 'operations-puppet-typos'
    defaults: use-zuul

    triggers:
     - zuul

    builders:
     - shell: |
        #!/bin/bash -e

        echo "Looking for usage of 'pmpta' instead of 'pmtpa'..."
        (fgrep -R --file=typos --exclude=typos *) && HAS_TYPO=1 || HAS_TYPO=0
        exit $HAS_TYPO

- project:
    name: 'operations-puppet'
    gerrit-name: 'operations/puppet'

    jobs:
     - '{name}-erblint-HEAD'
     - operations-puppet-typos
     - operations-puppet-validate
     - operations-puppet-doc
     - operations-puppet-pep8

# puppet modules
#
# To add a new puppet module, simply copy paste an existing one
# and tweak the `name` and `gerrit-name` parameters.
- project:
    name: 'operations-puppet-cdh4'
    gerrit-name: 'operations/puppet/cdh4'

    jobs:
     - '{name}-erblint-HEAD'
     - '{name}-pplint-HEAD'

- project:
    name: 'operations-puppet-kafka'
    gerrit-name: 'operations/puppet/kafka'
    node: 'gallium'

    jobs:
     - '{name}-erblint-HEAD'
     - '{name}-pplint-HEAD'

- project:
    name: 'operations-puppet-zookeeper'
    gerrit-name: 'operations/puppet/zookeeper'
    node: 'gallium'

    jobs:
     - '{name}-erblint-HEAD'
     - '{name}-pplint-HEAD'
