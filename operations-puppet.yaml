- job-template:
    name: 'operations-puppet-validate'
    defaults: use-zuul

    triggers:
     - zuul

    builders:
     - shell: "/bin/sed -i 's%import \"../private%#import \"../private%' manifests/base.pp"

    # Run rake validate if and only if rakefile has NOT been altered
    # by the submitted patchset.
     - shell: |
        #!/bin/bash -e

        # Zuul merge changes in the branch which is then known is the
        # job workspace as origin/branch. So we have to look up the sha1
        # of the original branch by querying the Zuul maintained repo
        ORIG_HEAD=`git --git-dir=/var/lib/zuul/git/operations/puppet/.git rev-parse "origin/$ZUUL_BRANCH"`
        echo "Original HEAD origin/$ZUUL_BRANCH points to $ORIG_HEAD"

        echo "Finding out whether the rakefile has been altered.."
        (   # exit 0 if rakefile got changed
            git diff --name-only "$ORIG_HEAD"..HEAD |grep rakefile>/dev/null
        ) && (
            echo "SKIPPING puppet validation: rakefile has been changed"
        ) || (
            rake --rakefile rakefile validate
        )

# Find out common typos in any files of ops/puppet
- job-template:
    name: 'operations-puppet-typos'
    defaults: use-zuul

    triggers:
     - zuul

    builders:
     - shell: |
        #!/bin/bash -e

        echo "Looking for usage of 'pmpta' instead of 'pmtpa'..."
        (fgrep -R --file=typos --exclude=typos *) && HAS_TYPO=1 || HAS_TYPO=0
        exit $HAS_TYPO

- project:
    name: 'operations-puppet'
    gerrit-name: 'operations/puppet'

    jobs:
     - '{name}-pep8'
     - operations-puppet-typos
     - operations-puppet-validate
