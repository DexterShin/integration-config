- job-template:
    name: 'operations-puppet-validate'
    node: gallium  # relies on /srv/ssd/zuul/git/operations/puppet
    defaults: use-remote-zuul-no-submodules

    triggers:
     - zuul

    builders:
    # Run rake validate if and only if rakefile has NOT been altered
    # by the submitted patchset.
     - shell: |
        #!/bin/bash -e

        # Zuul merge changes in the branch which is then known is the
        # job workspace as origin/branch. So we have to look up the sha1
        # of the original branch by querying the Zuul maintained repo
        ORIG_HEAD=`git --git-dir=/srv/ssd/zuul/git/operations/puppet/.git rev-parse "origin/$ZUUL_BRANCH"`
        echo "Original HEAD origin/$ZUUL_BRANCH points to $ORIG_HEAD"

        echo "Finding out whether the rakefile has been altered.."
        (   # exit 0 if rakefile got changed
            git diff --name-only "$ORIG_HEAD"..HEAD |grep rakefile>/dev/null
        ) && (
            echo "SKIPPING puppet validation: rakefile has been changed"
        ) || (
            rake --rakefile rakefile validate color=true
        )

# Trigger integration tests hold in 'tests' sub directories as manifests.
# See the shell wrapper in integration/jenkins.git
- job-template:
    name: 'operations-puppet-test'
    node: hasSlaveScripts
    defaults: use-remote-zuul

    triggers:
     - zuul

    builders:
     - shell: "/var/lib/jenkins/bin/puppet-test-runner.sh"

# Run pep8 per file so that individual puppet dirs
#  can specify their own .pep8 rules
- job-template:
    name: 'operations-puppet-pep8'
    node: hasSlaveScripts
    defaults: use-remote-zuul

    triggers:
     - zuul

    builders:
      # Requires Jenkins slave scripts
      - shell: |
         set -o pipefail
         "$JENKINS_HOME"/tools/puppet_pep8.py . | tee pep8.txt
         set +o pipefail

    publishers:
     - pep8

# Documentation for our puppet repository
- job-template:
    name: 'operations-puppet-doc'
    node: gallium  # webhost where doc is published
    defaults: use-zuul  # bound to gallium
    triggers:
     - zuul
    workspace: '/srv/org/wikimedia/doc/puppetsource'
    builders:
     - shell: |
        #!/bin/bash -e
        /usr/bin/puppet doc \
            --mode rdoc \
            --outputdir /srv/org/wikimedia/doc/puppet \
            --modulepath "$WORKSPACE/modules" \
            --manifestdir "$WORKSPACE/manifests"

# Find out common typos in any files of ops/puppet
- job-template:
    name: 'operations-puppet-typos'
    defaults: use-remote-zuul

    triggers:
     - zuul

    builders:
     - shell: |
        #!/bin/bash -e

        echo "Looking for usage of 'pmpta' instead of 'pmtpa'..."
        (fgrep -R --file=typos --exclude=typos *) && HAS_TYPO=1 || HAS_TYPO=0
        exit $HAS_TYPO

- project:
    name: 'operations-puppet'

    jobs:
     - '{name}-erblint-HEAD'
     - operations-puppet-typos
     - operations-puppet-validate
     - operations-puppet-test
     - operations-puppet-doc
     - operations-puppet-pep8

# puppet modules
#
# To add a new puppet module, simply copy paste an existing one
# and tweak the `name` parameter.
- project:
    name: 'operations-puppet-cdh4'

    jobs:
     - '{name}-erblint-HEAD'
     - '{name}-pplint-HEAD'

- project:
    name: 'operations-puppet-jmxtrans'

    jobs:
     - '{name}-erblint-HEAD'
     - '{name}-pplint-HEAD'

- project:
    name: 'operations-puppet-kafka'

    jobs:
     - '{name}-erblint-HEAD'
     - '{name}-pplint-HEAD'

- project:
    name: 'operations-puppet-zookeeper'

    jobs:
     - '{name}-erblint-HEAD'
     - '{name}-pplint-HEAD'
