# vim: set ts=2 sw=2 et ai foldmethod=indent:
#
# This is the Zuul configuration file for the Wikimedia Foundation
#
# See http://ci.openstack.org/zuul/zuul.html#configuration
#

# Zuul configuration comes with three main sections:
#
# pipelines: filter Gerrit events and determine what is reported back in Gerrit
#            once all jobs have been run.
#
# jobs: let you override the pipeline configuration on a per job basis. A nice
#       way to handle exceptions to the usual workflow
#
# projects: Filter Gerrit event by project name then apply pipelines to filter
#           the Gerrit events.  Under each pipeline are listed jobs to trigger.
#           Jobs can be made dependant on each other.
#
# See upstream documentation at:
#
#   http://ci.openstack.org/zuul/zuul.html#layout-yaml


pipelines:
  # For some pipelines, we do not want to report anything back to Gerrit,
  # this is useful when trying out a new set of filter or when adding a new
  # repository in the workflow. Zuul still log the results in /var/log/zuul.log
  # but simply ignore reporting back to Gerrit.  By convention such pipelines
  # names are suffixed with '-silent'.

  # Pipeline doing prechecks such as syntax linting
  # Does NOT report back to Gerrit.
  - name: check-silent
    manager: IndependentPipelineManager
    trigger:
      - event: patchset-created
      - event: comment-added
        comment_filter: (?i)^\s*recheck\.?\s*$

  # Pipeline doing prechecks such as syntax linting
  # DOES report back to Gerrit.
  - name: check
    manager: IndependentPipelineManager
    trigger:
      - event: patchset-created
      - event: comment-added
        comment_filter: (?i)^\s*recheck\.?\s*$
    success:
      # Prevents people from being able to submit a change
      # before unit tests have been run since submit requires V+2.
      verified: 1
      # Remove potential CR-2 flag caused by unit tests failing previously
      code-review: 0
    failure:
      verified: -1
      # Remove potential CR-2 flag caused by unit tests failing previously
      code-review: 0

  # Voting check for project that lack unit tests and only rely
  # on lint check. Similiar to 'check' but additionally vote V+2
  # This is mostly for operations/puppet which ask to get V+2 whenever
  # change is linted since they dont have unit tests.
  - name: check-voter
    manager: IndependentPipelineManager
    trigger:
      - event: patchset-created
      - event: comment-added
        comment_filter: (?i)^\s*recheck\.?\s*$
    success:
      verified: 2
      # Remove potential CR-2 flag caused by unit tests failing previously
      code-review: 0
    failure:
      verified: -1
      # Remove potential CR-2 flag caused by unit tests failing previously
      code-review: 0

  - name: test
    manager: IndependentPipelineManager
    trigger:
      - event: patchset-created

        # Make sure to use non greedy selectors (.*?) and to escape
        # dots: \.

        email_filter: .*?@wikimedia\.org$
        email_filter: .*?@wikimedia\.de$

        # WMF Contractors:
        email_filter: ^anomie\.wikipedia@gmail\.com$
        email_filter: ^amir\.aharoni@mail\.huji\.ac\.il$
        email_filter: ^hashar@free\.fr$
        email_filter: ^jeroendedauw@gmail\.com$
        email_filter: ^maxsem\.wiki@gmail\.com$
        email_filter: ^mtraceur@member\.fsf\.org$
        email_filter: ^niklas\.laxstrom@gmail\.com$
        email_filter: ^s\.mazeland@xs4all\.nl$
        email_filter: ^stefan\.petrea@gmail\.com$
        email_filter: ^stefan@garage-coding\.com$

        # WMDE:
        email_filter: ^aude\.wiki@gmail\.com$

        # Trusted long term users:
        email_filter: ^dereckson@espace-win\.org$
        email_filter: ^ialex\.wiki@gmail\.com$
        email_filter: ^hartman\.wiki@gmail\.com$
        email_filter: ^liangent@gmail\.com$
        email_filter: ^mah@everybody\.org$
        email_filter: ^raimond\.spekking@gmail\.com$
        email_filter: ^robinp\.1273@gmail\.com$
        email_filter: ^tim@tim-landscheidt\.de$
        email_filter: ^umherirrender_de\.wp@web\.de$

    success:
      verified: 2
      code-review: 0
    failure:
      verified: -1
      code-review: -2

  # Pipelines that only get run when someone trusted has reviewed the code
  # (cr +2). Should be used to run tests and will report verified +2/-2.
  #
  # Silent gate (does not report anything back to Gerrit):
  - name: gate-silent
    manager: IndependentPipelineManager
    trigger:
      - event: comment-added
        approval:
          - code-review: 2

  # Actual gate (report/vote in Gerrit)
  #
  # WARNING: do modify the gate-and-submit pipeline below whenever
  #          changing the gate pipeline.
  #
  - name: gate
    manager: IndependentPipelineManager
    trigger:
      - event: comment-added
        approval:
          - code-review: 2
    success:
      verified: 2
      # Remove potential CR-2 flag caused by unit tests failing previously
      code-review: 0
    failure:
      verified: -1
      # We really want to block submission when tests fails
      code-review: -2

  # Actual gate (report/vote in Gerrit)
  # Will auto submit change on success!!!!!!!!
  #
  # WARNING: do modify the gate pipeline below whenever changing
  #          the gate-and-submit pipeline.
  #
  - name: gate-and-submit
    manager: IndependentPipelineManager
    trigger:
      - event: comment-added
        approval:
          - code-review: 2
    success:
      verified: 2
      # Remove potential CR-2 flag caused by unit tests failing previously
      code-review: 0
      # Let Zuul merge the change \O/
      submit: true
    failure:
      verified: -1
      # We really want to block submission when tests fails
      code-review: -2

  # Filter the merge events, useful to do regression testing.
  - name: postmerge
    manager: IndependentPipelineManager
    trigger:
      - event: change-merged
# Silented for production deployment
#    success:
#      code-review: 0
#      verified: 0
#      force-message: True
#    failure:
#      code-review: 0
#      verified: 0
#      force-message: True

# Fine tune some jobs
jobs:
  - name: ^.*merge$
    failure-message: Change could not be automatically merged. Please rebase it and reupload.

  # JSLint
  #
  # Disabled by default since most MediaWiki extensions do not pass tests yet:
  - name: ^.*-jslint$
    voting: false  # Until we are sure it works fine

  # Python linter, most of our script fail the tests miserably
  - name: ^.*-pep8$
    voting: false

  # Explicitly enable voting for extensions we know are passing JSHint:
  - name: mwext-Translate-jslint
    voting: true
  - name: mwext-VisualEditor-jslint
    voting: true

  # Various failing jobs that need to be fixed eventually

  # Echo installer does not support SQLite backend :-/
  - name: mwext-Echo-testextensions.*
    voting: false

  # GeoMathTest::testRectWrapAround() fails as of Dec 5th 2012
  - name: mwext-GeoData-testextensions.*
    voting: false

  # LabeledSectionTransclusion has only parser tests which does not
  # play well for now. https://gerrit.wikimedia.org/r/#/c/38114 should
  # let PHPUnit load in the parser tests though. See bug 42506.
  - name: mwext-LabeledSectionTransclusion-testextensions.*
    voting: false

  - name: mediawiki-core-master-phpunit-all
    branch: ^master$
    success-message: Change looked fine once merged.
    failure-message: ERROR! It seems this job introduced a regression although it might be caused by a previous commit.

  # MediaWiki Core regression tests (on merge and per branches):
  - name: ^mediawiki-core-regression-.*
    failure-message: ERROR! It seems this job introduced a regression although it might be caused by a previous commit.
  - name: mediawiki-core-regression-master
    branch: ^master$
  - name: mediawiki-core-regression-REL1_19
    branch: ^REL1_19$
  - name: mediawiki-core-regression-REL1_20
    branch: ^REL1_20$
  # Extensions for which tests are non functional or absents:
  - name: mwext-EtherEditor-testextensions.*
    voting: false
  - name: mwext-cldr-testextensions.*
    voting: false
  - name: mwext-TranslationNotifications-testextensions.*
    voting: false

# Register the Gerrit project name, apply them pipelines that in turn trigger
# a set of jobs.
projects:
  - name: mediawiki/core
    check:
      - mediawiki-core-merge:
        - mediawiki-core-lint
    test:
      - mediawiki-core-merge:
        - mediawiki-core-lint:
          - mediawiki-core-phpunit-databaseless:
            - mediawiki-core-install-sqlite:
              - mediawiki-core-phpunit-api
              - mediawiki-core-phpunit-misc
              - mediawiki-core-phpunit-parser
    gate-and-submit:
      - mediawiki-core-merge:
        - mediawiki-core-lint:
          - mediawiki-core-phpunit-databaseless:
            - mediawiki-core-install-sqlite:
              - mediawiki-core-phpunit-api
              - mediawiki-core-phpunit-misc
              - mediawiki-core-phpunit-parser
    postmerge:
      - mediawiki-core-lint
      - mediawiki-core-master-phpunit-all
      - mediawiki-core-regression-master
      - mediawiki-core-regression-REL1_19
      - mediawiki-core-regression-REL1_20

  - name: analytics/libanon
    test:
     - analytics-libanon
    gate:
     - analytics-libanon
    postmerge:
     - analytics-libanon

  - name: analytics/udp-filters
    test:
     - analytics-udp-filters
    gate:
     - analytics-udp-filters
    postmerge:
     - analytics-udp-filters

  - name: analytics/webstatscollector
    test:
     - analytics-webstatscollector
    gate:
     - analytics-webstatscollector
    postmerge:
     - analytics-webstatscollector

  - name: analytics/wikistats
    test:
     - analytics-wikistats
    gate:
     - analytics-wikistats
    postmerge:
     - analytics-wikistats

  - name: labs/nagios-builder
    check-voter:
      - labs-nagios-builder-pep8

  - name: operations/mediawiki-config
    check:
      - operations-mw-config-phplint:
        - operations-mw-config-tests
    gate:
      - operations-mw-config-phplint:
        - operations-mw-config-tests

  - name: operations/puppet
    # Only lint on submission for now, that will be voting
    check-voter:
      - operations-puppet-pep8
      - operations-puppet-typos
      - operations-puppet-validate

  - name: operations/software
    check-voter:
      - operations-software-pep8

  - name: translatewiki
    check:
      - translatewiki-phplint
      - translatewiki-puppet-validate
      - translatewiki-shelllint
    gate:
      - translatewiki-phplint
      - translatewiki-puppet-validate
      - translatewiki-shelllint

  - name: wikimedia/bugzilla/wikibugs
    # Only lint on submission for now, that will be voting
    check-voter:
      - wikimedia-bugzilla-wikibugs-perllint

#### MediaWiki extensions #############################################

  - name: mediawiki/extensions/Babel
    check:
      - mwext-Babel-merge:
        - mwext-Babel-jslint
        - mwext-Babel-lint
    gate:
      - mwext-Babel-merge:
        - mwext-Babel-jslint
        - mwext-Babel-lint

  - name: mediawiki/extensions/cldr
    check:
      - mwext-cldr-merge:
        - mwext-cldr-jslint
        - mwext-cldr-lint
    gate:
      - mwext-cldr-merge:
        - mwext-cldr-jslint
        - mwext-cldr-lint:
          - mwext-cldr-testextensions-master

  - name: mediawiki/extensions/CleanChanges
    check:
      - mwext-CleanChanges-merge:
        - mwext-CleanChanges-jslint
        - mwext-CleanChanges-lint
    gate:
      - mwext-CleanChanges-merge:
        - mwext-CleanChanges-jslint
        - mwext-CleanChanges-lint

  - name: mediawiki/extensions/DataValues
    check:
      - mwext-DataValues-merge:
#        - mwext-DataValues-jslint
        - mwext-DataValues-lint
    gate:
      - mwext-DataValues-merge:
#        - mwext-DataValues-jslint
        - mwext-DataValues-lint:
          - mwext-DataValues-testextensions-master

  - name: mediawiki/extensions/EtherEditor
    check:
      - mwext-EtherEditor-merge:
#        - mwext-EtherEditor-jslint
        - mwext-EtherEditor-lint
    gate:
      - mwext-EtherEditor-merge:
        - mwext-EtherEditor-lint:
#        - mwext-EtherEditor-jslint
          - mwext-EtherEditor-testextensions-master

  - name: mediawiki/extensions/Diff
    check:
      - mwext-Diff-merge:
        - mwext-Diff-jslint
        - mwext-Diff-lint
    gate:
      - mwext-Diff-merge:
        - mwext-Diff-jslint
        - mwext-Diff-lint:
          - mwext-Diff-testextensions-master

  - name: mediawiki/extensions/Echo
    check:
      - mwext-Echo-merge:
        - mwext-Echo-jslint
        - mwext-Echo-lint
    gate:
      - mwext-Echo-merge:
        - mwext-Echo-jslint
        - mwext-Echo-lint:
          - mwext-Echo-testextensions-master

  - name: mediawiki/extensions/EventLogging
    check:
      - mwext-EventLogging-merge:
        - mwext-EventLogging-jslint
        - mwext-EventLogging-lint
    gate:
      - mwext-EventLogging-merge:
        - mwext-EventLogging-jslint
        - mwext-EventLogging-lint:
          - mwext-EventLogging-testextensions-master

  - name: mediawiki/extensions/GeoData
    check:
      - mwext-GeoData-merge:
        - mwext-GeoData-jslint
        - mwext-GeoData-lint
    gate:
      - mwext-GeoData-merge:
        - mwext-GeoData-jslint
        - mwext-GeoData-lint:
          - mwext-GeoData-testextensions-master

  - name: mediawiki/extensions/LabeledSectionTransclusion
    check:
      - mwext-LabeledSectionTransclusion-merge:
        - mwext-LabeledSectionTransclusion-jslint
        - mwext-LabeledSectionTransclusion-lint
    gate:
      - mwext-LabeledSectionTransclusion-merge:
        - mwext-LabeledSectionTransclusion-jslint
        - mwext-LabeledSectionTransclusion-lint:
          - mwext-LabeledSectionTransclusion-testextensions-master

  - name: mediawiki/extensions/LiquidThreads
    check:
      - mwext-LiquidThreads-merge:
        - mwext-LiquidThreads-jslint
        - mwext-LiquidThreads-lint
    gate:
      - mwext-LiquidThreads-merge:
        - mwext-LiquidThreads-jslint
        - mwext-LiquidThreads-lint
# No unit tests for now :(

  - name: mediawiki/extensions/LocalisationUpdate
    check:
      - mwext-LocalisationUpdate-merge:
        - mwext-LocalisationUpdate-jslint
        - mwext-LocalisationUpdate-lint
    gate:
      - mwext-LocalisationUpdate-merge:
        - mwext-LocalisationUpdate-jslint
        - mwext-LocalisationUpdate-lint

  - name: mediawiki/extensions/MobileFrontend
    check:
      - mwext-MobileFrontend-merge:
        - mwext-MobileFrontend-lint
        - mwext-MobileFrontend-jslint
    gate:
      - mwext-MobileFrontend-merge:
        - mwext-MobileFrontend-jslint
        - mwext-MobileFrontend-lint:
          - mwext-MobileFrontend-testextensions-master

  - name: mediawiki/extensions/OpenStackManager
    check:
      - mwext-OpenStackManager-merge:
        - mwext-OpenStackManager-lint
        - mwext-OpenStackManager-jslint
    gate:
      - mwext-OpenStackManager-merge:
        - mwext-OpenStackManager-jslint
        - mwext-OpenStackManager-lint
# No unit tests for now :(
#        - mwext-OpenStackManager-lint:
#          - mwext-OpenStackManager-testextensions-master

  - name: mediawiki/extensions/ParserFunctions
    check:
      - mwext-ParserFunctions-merge:
        - mwext-ParserFunctions-jslint
        - mwext-ParserFunctions-lint
    gate:
      - mwext-ParserFunctions-merge:
        - mwext-ParserFunctions-jslint
        - mwext-ParserFunctions-lint:
          - mwext-ParserFunctions-testextensions-master

  # Parsoid is mostly JavaScript so we just run jsHint (and merge of course)
  - name: mediawiki/extensions/Parsoid
    check:
      - mwext-Parsoid-merge:
        - mwext-Parsoid-jslint
    gate:
      - mwext-Parsoid-merge:
        - mwext-Parsoid-jslint

  - name: mediawiki/extensions/Renameuser
    check:
      - mwext-Renameuser-merge:
        - mwext-Renameuser-lint
        - mwext-Renameuser-jslint
    gate:
      - mwext-Renameuser-merge:
        - mwext-Renameuser-jslint
        - mwext-Renameuser-lint
# No Unit tests yet :(
#        - mwext-Renameuser-lint:
#          - mwext-Renameuser-testextensions-master

  - name: mediawiki/extensions/Score
    check:
      - mwext-Score-merge:
        - mwext-Score-lint
        - mwext-Score-jslint
    gate:
      - mwext-Score-merge:
        - mwext-Score-jslint
        - mwext-Score-lint
# No Unit tests yet :(
#        - mwext-Score-lint:
#          - mwext-Score-testextensions-master

  - name: mediawiki/extensions/SVGEdit
    check:
      - mwext-SVGEdit-merge:
        - mwext-SVGEdit-jslint
        - mwext-SVGEdit-lint
    gate:
      - mwext-SVGEdit-merge:
        - mwext-SVGEdit-jslint
        - mwext-SVGEdit-lint
# No PHPUnit tests for now so simply disable triggering them
# If you want to enable PHPUnit tests, delete the line above
# and uncomment the two lines below:
#        - mwext-SVGEdit-lint:
#          - mwext-SVGEdit-testextensions-master

  - name: mediawiki/extensions/TimedMediaHandler
    check:
      - mwext-TimedMediaHandler-merge:
        - mwext-TimedMediaHandler-jslint
        - mwext-TimedMediaHandler-lint
    gate:
      - mwext-TimedMediaHandler-merge:
        - mwext-TimedMediaHandler-jslint
        - mwext-TimedMediaHandler-lint
# Requires the MwEmbedSupport extension :(
#        - mwext-TimedMediaHandler-lint:
#          - mwext-TimedMediaHandler-testextensions-master

  - name: mediawiki/extensions/TitleBlacklist
    check:
      - mwext-TitleBlacklist-merge:
        - mwext-TitleBlacklist-jslint
        - mwext-TitleBlacklist-lint
    gate:
      - mwext-TitleBlacklist-merge:
        - mwext-TitleBlacklist-jslint
        - mwext-TitleBlacklist-lint:
          - mwext-TitleBlacklist-testextensions-master

  - name: mediawiki/extensions/Translate
    check:
      - mwext-Translate-merge:
        - mwext-Translate-jslint
        - mwext-Translate-lint
    gate-and-submit:
      - mwext-Translate-merge:
        - mwext-Translate-jslint
        - mwext-Translate-lint:
          - mwext-Translate-testextensions-master

  - name: mediawiki/extensions/TranslationNotifications
    check:
      - mwext-TranslationNotifications-merge:
        - mwext-TranslationNotifications-jslint
        - mwext-TranslationNotifications-lint
    gate-and-submit:
      - mwext-TranslationNotifications-merge:
        - mwext-TranslationNotifications-jslint
        - mwext-TranslationNotifications-lint:
          - mwext-TranslationNotifications-testextensions-master

  - name: mediawiki/extensions/UniversalLanguageSelector
    check:
      - mwext-UniversalLanguageSelector-merge:
#        - mwext-UniversalLanguageSelector-jslint
        - mwext-UniversalLanguageSelector-lint
    gate:
      - mwext-UniversalLanguageSelector-merge:
#        - mwext-UniversalLanguageSelector-jslint
        - mwext-UniversalLanguageSelector-lint:
          - mwext-UniversalLanguageSelector-testextensions-master

  - name: mediawiki/extensions/Validator
    check:
      - mwext-Validator-merge:
        - mwext-Validator-jslint
        - mwext-Validator-lint
    gate:
      - mwext-Validator-merge:
        - mwext-Validator-jslint
        - mwext-Validator-lint:
          - mwext-Validator-testextensions-master

  - name: mediawiki/extensions/VisualEditor
    check:
      - mwext-VisualEditor-merge:
        - mwext-VisualEditor-jslint
        - mwext-VisualEditor-lint
    gate-and-submit:
      - mwext-VisualEditor-merge:
        - mwext-VisualEditor-jslint
        - mwext-VisualEditor-lint
# VE team does not need any install nor has any PHP Unit tests
# so skip the installer entirely and PHPUnit tests.

  - name: mediawiki/extensions/Wikibase
    check-silent:
      - mwext-Wikibase-merge:
        - mwext-Wikibase-jslint
        - mwext-Wikibase-lint
    gate-silent:
      - mwext-Wikibase-merge:
        - mwext-Wikibase-jslint
        - mwext-Wikibase-lint:
          - mwext-Wikibase-testextensions-master

  - name: mediawiki/extensions/WikimediaMaintenance
    check:
      - mwext-WikimediaMaintenance-merge:
        - mwext-WikimediaMaintenance-jslint
        - mwext-WikimediaMaintenance-lint
    gate-and-submit:
      - mwext-WikimediaMaintenance-merge:
        - mwext-WikimediaMaintenance-jslint
        - mwext-WikimediaMaintenance-lint
# No unit tests yet :/
#        - mwext-WikimediaMaintenance-lint:
#          - mwext-WikimediaMaintenance-testextensions-master
