# This file holds the configuration for all MediaWiki core related jobs
# regardless of them being lint, merge check, unit test or regression testing.

# FIXME: use /var/lib/zuul/git/{gerrit-name}

# Note that mediawiki/core branches may have a lot of submodules, we thus
# use a specific git macro to prevents Jenkins from updating all the
# submodules we do not care about. See bug 42455.

# Basic jobs used to merge the change against the latest
# version in the repository.
- job-template:
    name: '{name}-merge'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

# Generic job used to lint projects
- job-template:
    name: '{name}-lint'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builders:
     - ant:
         targets: "php-lint"
         buildfile: "/var/lib/jenkins/jobs/_shared/build.xml"
     - jshint

- job-template:
    name: '{name}-whitespaces'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builder:
     - lint-whitespaces

# A job template to trigger phpunit groups against a repository.
#
# @param name Jenkins job prefix to use
# @param phpunit-group suffix for an ant target 'phpunit-{phpunit-group}
# @param gerrit-name Gerrit project name (ex: mediawiki/core)
- job-template:
    name: '{name}-phpunit-{phpunit-group}'

    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

    publishers:
     - xunit:
        thresholdmode: 'percent'
        thresholds:
          - failed:
              unstable: 0
              unstablenew: 0
              failure: 0
              failurenew: 0
          - skipped:
              unstable: 0
              unstablenew: 0
              failure: 0
              failurenew: 0
        types:
          - phpunit:
              pattern: 'logs/junit.xml'
    builders:
     - ant:
         targets: "phpunit-{phpunit-group}"
         buildfile: "/var/lib/jenkins/jobs/_shared/build.xml"

# A job template to install MediaWiki against a specific DB backend
#
# @param name name Jenkins job prefix to use
# @param databasetype Suffix for an ant target 'installdb-{databasetype}'
- job-template:
    name: '{name}-install-{databasetype}'

    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

    builders:
     - ant:
         targets: "installdb-{databasetype}"
         buildfile: "/var/lib/jenkins/jobs/_shared/build.xml"

- job-group:
    name: mediawiki-jobs
    jobs:
      - '{name}-merge'
      - '{name}-lint'
      - '{name}-whitespaces'
      - '{name}-phpunit-{phpunit-group}'
      - '{name}-install-{databasetype}'

- project:
    name: mediawiki-core
    gerrit-name: mediawiki/core
    phpunit-group:
      - api
      - databaseless
      - misc
      - parser
    databasetype:
      - sqlite
    jobs:
      - mediawiki-jobs

# For regression testing:

- job-template:
    name: 'mediawiki-core-regression-{branch}'

    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

    builders:
     - ant:
        targets: 'phpunit-all'
        buildfile: '/var/lib/jenkins/jobs/_shared/build.xml'

- project:
    name: mediawiki-core-regression
    gerrit-name: mediawiki/core
    branch:
      - master
      - REL1_19
      - REL1_20
    # Find a way to support WMF branches
    jobs:
     - 'mediawiki-core-regression-{branch}'
