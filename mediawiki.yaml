# This file holds the configuration for all MediaWiki core related jobs
# regardless of them being lint, merge check, unit test or regression testing.

# Note that mediawiki/core branches may have a lot of submodules, we thus
# use a specific git macro to prevents Jenkins from updating all the
# submodules we do not care about. See bug 42455.

- job-template:
    name: '{name}-lint'
    node: hasSlaveScripts
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builders:
     - phplint

# Generic job to run QUnit
- job-template:
    name: '{name}-qunit'
    node: hasSlaveScripts
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

    builders:
     - mw-install-sqlite
     - mw-apply-settings
     - qunit

- job-template:
    name: '{name}-jsduck'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builders:
     - jsduck:
        config: '$WORKSPACE/maintenance/jsduck/config.json'

- job-template:
    name: '{name}-jsduck-publish'
    node: gallium
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builders:
     - jsduck:
        config: '$WORKSPACE/maintenance/jsduck/config.json'
     - shell: |
        rsync --recursive --delete-after --force $WORKSPACE/resources/ "$WORKSPACE/docs/js/modules/"
     - documentation-sync-subdir:
        src: '$WORKSPACE/docs/js'
        project: 'mediawiki-core'
        version: '$GERRIT_BRANCH'
        subdir: 'js/'

- job-template:
    name: '{name}-doxygen-publish'
    node: gallium
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builders:
     - shell: "/var/lib/jenkins/tools/mwcore-docgen.sh"

- job-template:
    name: '{name}-whitespaces'
    node: hasSlaveScripts
    defaults: use-remote-zuul
    scm:
     - git-mwcore
    triggers:
     - zuul
    builder:
     - lint-whitespaces

# A job template to trigger phpunit groups against a repository.
#
# @param name Jenkins job prefix to use
# @param phpunit-group suffix for an ant target 'phpunit-{phpunit-group}
- job-template:
    name: '{name}-phpunit-{phpunit-group}'
    node: (hasSlaveScripts && hasPhpUnit)
    defaults: use-remote-zuul
    scm:
     - git-mwcore
    triggers:
     - zuul

    builders:
     - mw-install-sqlite
     - mw-apply-settings
     - shell: "/srv/slave-scripts/bin/mw-run-phpunit.sh {phpunit-group}"
    publishers:
     - phpunit-junit-2
     - archive-log-dir

# A job template to install MediaWiki against a specific DB backend
#
# @param name name Jenkins job prefix to use
# @param databasetype Suffix for an ant target 'installdb-{databasetype}'
- job-template:
    name: '{name}-install-{databasetype}'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

    builders:
     # FIXME no more supports "databasetype"
     - mw-install-sqlite

- job-template:
    name: 'mediawiki-core-release'

    triggers:
     - zuul-post

    # Fetch latest version of the release script
    scm:
     - git:
        url: '/srv/ssd/gerrit/mediawiki/tools/release'
        wipe-workspace: true

    builders:
     - shell: |
        VERSION=`echo "$ZUUL_REF"|sed 's%^refs/tags/%%'`
        echo "From tag $ZUUL_REF, extracted version $VERSION"
        python make-release/make-release.py \
            --yes \
            --conf 'make-release/make-release.yaml' \
            --git-root '/srv/ssd/gerrit/mediawiki' \
            --dont-sign \
            "$VERSION"

    publishers:
     - archive:
         artifacts: 'build/*.gz'

- job-group:
    name: mediawiki-jobs
    jobs:
      - '{name}-lint'
      - '{name}-jslint'
      - '{name}-qunit'
      - '{name}-jsduck'
      - '{name}-jsduck-publish'
      - '{name}-doxygen-publish'
      - '{name}-whitespaces'
      - '{name}-phpcs-lenient'
      - '{name}-phpcs-lenient-HEAD'
      - '{name}-phpcs-strict'
      - '{name}-phpcs-strict-HEAD'
      - '{name}-phpunit-{phpunit-group}'
      - '{name}-install-{databasetype}'

- project:
    name: mediawiki-core
    phpunit-group:
      - api
      - databaseless
      - misc
      - parser
    databasetype:
      - sqlite
    jobs:
      - mediawiki-jobs
      - '{name}-phpcs-HEAD'
      - mediawiki-core-release

# For regression testing:

- job-template:
    name: 'mediawiki-core-regression-{branch}'
    node: (hasSlaveScripts && hasPhpUnit)
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

    builders:
     - mw-install-sqlite
     - mw-apply-settings
     - shell: "/srv/slave-scripts/bin/mw-run-phpunit.sh"
    publishers:
     - phpunit-junit-2
     - archive-log-dir

- job:
    name: 'mediawiki-core-code-coverage'
    node: gallium
    defaults: global
    builders:
     - wipe-workspace
     - get-mw-core:
        branch: 'master'
     - mw-install-sqlite
     # FIXME should use the mw-run-phpunit.sh wrapper
     - shell: |
        nice -n 19 php tests/phpunit/phpunit.php \
            --with-phpunitdir /srv/deployment/integration/phpunit/vendor/phpunit/phpunit \
            --exclude-group Dump,Broken,ParserFuzz,Stub \
            --coverage-html /srv/org/wikimedia/integration/cover/mediawiki-core/master/php
        echo "Code coverage report is available at:"
        echo "https://integration.wikimedia.org/cover/mediawiki-core/master/php"
    triggers:
     - timed: '0 3 * * *'
    wrappers:
     - ansicolor
     - timestamps

- project:
    name: mediawiki-core-regression
    branch:
      - master
      - REL1_19
      - REL1_20
      - REL1_21
      - REL1_22
    # Find a way to support WMF branches
    jobs:
     - 'mediawiki-core-regression-{branch}'
     - '{name}-phpcs'
     - '{name}-phpcs-HEAD'
