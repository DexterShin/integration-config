# This file holds the configuration for all MediaWiki core related jobs
# regardless of them being lint, merge check, unit test or regression testing.

# FIXME: use /srv/ssd/zuul/git/{gerrit-name}

# Note that mediawiki/core branches may have a lot of submodules, we thus
# use a specific git macro to prevents Jenkins from updating all the
# submodules we do not care about. See bug 42455.

# Basic jobs used to merge the change against the latest
# version in the repository.
- job-template:
    name: '{name}-merge'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

- job-template:
    name: '{name}-lint'
    node: hasSlaveScripts
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builders:
     - phplint

# Generic job to run JSHint
- job-template:
    name: '{name}-jslint'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builders:
     - jshint

# Generic job to run QUnit
- job-template:
    name: '{name}-qunit'
    node: master  # FIXME move to slave 'gallium'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

    builders:
     - mw-install-sqlite
     - qunit

- job-template:
    name: '{name}-jsduck'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builders:
     - jsduck:
        config: '$WORKSPACE/maintenance/jsduck/config.json'

- job-template:
    name: '{name}-jsduck-publish'
    node: gallium
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builders:
     - jsduck:
        config: '$WORKSPACE/maintenance/jsduck/config.json'
     - documentation-sync-subdir:
        src: '$WORKSPACE/docs/js'
        project: 'mediawiki-core'
        version: '$GERRIT_BRANCH'
        subdir: 'js/'

- job-template:
    name: '{name}-doxygen-publish'
    node: gallium
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builders:
     - shell: "/var/lib/jenkins/tools/mwcore-docgen.sh"

- job-template:
    name: '{name}-whitespaces'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul
    builder:
     - lint-whitespaces

# A job template to trigger phpunit groups against a repository.
#
# @param name Jenkins job prefix to use
# @param phpunit-group suffix for an ant target 'phpunit-{phpunit-group}
# @param gerrit-name Gerrit project name (ex: mediawiki/core)
- job-template:
    name: '{name}-phpunit-{phpunit-group}'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

    publishers:
     - phpunit-junit
    builders:
     - ant:
         targets: "phpunit-{phpunit-group}"
         buildfile: "/var/lib/jenkins/jobs/_shared/build.xml"

# A job template to install MediaWiki against a specific DB backend
#
# @param name name Jenkins job prefix to use
# @param databasetype Suffix for an ant target 'installdb-{databasetype}'
- job-template:
    name: '{name}-install-{databasetype}'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

    builders:
     - ant:
         targets: "installdb-{databasetype}"
         buildfile: "/var/lib/jenkins/jobs/_shared/build.xml"

- job-group:
    name: mediawiki-jobs
    jobs:
      - '{name}-merge'
      - '{name}-lint'
      - '{name}-jslint'
      - '{name}-qunit'
      - '{name}-jsduck'
      - '{name}-jsduck-publish'
      - '{name}-doxygen-publish'
      - '{name}-whitespaces'
      - '{name}-phpunit-{phpunit-group}'
      - '{name}-install-{databasetype}'

- project:
    name: mediawiki-core
    gerrit-name: mediawiki/core
    phpunit-group:
      - api
      - databaseless
      - misc
      - parser
    databasetype:
      - sqlite
    jobs:
      - mediawiki-jobs
      - '{name}-phpcs-HEAD'

# For regression testing:

- job-template:
    name: 'mediawiki-core-regression-{branch}'
    node: master  # FIXME move to slave 'gallium'
    defaults: use-zuul
    scm:
     - git-mwcore-nosubmodules
    triggers:
     - zuul

    builders:
     - ant:
        targets: 'phpunit-all'
        buildfile: '/var/lib/jenkins/jobs/_shared/build.xml'

- job:
    name: 'mediawiki-core-code-coverage'
    node: gallium
    defaults: global
    builders:
     - wipe-workspace
     - get-mw-core:
        branch: 'master'
     - mw-install-sqlite
     - shell: |
        php tests/phpunit/phpunit.php \
            --exclude-group Dump,Broken,ParserFuzz,Stub \
            --coverage-html /srv/org/wikimedia/integration/cover/mediawiki-core/master/php
        echo "Code coverage report is available at:"
        echo "https://integration.wikimedia.org/cover/mediawiki-core/master/php"
    triggers:
     - timed: '0 3 * * *'
    wrappers:
     - ansicolor
     - timestamps

- project:
    name: mediawiki-core-regression
    gerrit-name: mediawiki/core
    branch:
      - master
      - REL1_19
      - REL1_20
      - REL1_21
    # Find a way to support WMF branches
    jobs:
     - 'mediawiki-core-regression-{branch}'
     - '{name}-phpcs'
     - '{name}-phpcs-HEAD'
