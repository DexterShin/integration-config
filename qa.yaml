# Macro to install qa/browsertests and create a tarball out of it
- builder:
    name: qa-browsertests-build
     # See bug 54384 for some background
    builders:
     - shell: |
         # Shared cache of gems to avoid hitting rubygems all the time
         # See https://github.com/bundler/bundler/issues/2856
         export GEM_HOME="$WORKSPACE/../gems"

         mkdir vendor

         # Fetch bundle from rubygems repo
         gem1.9.3 install --env-shebang -i vendor bundler --no-ri --no-rdoc

         # Prepare some paths lookup
         export GEM_PATH="`pwd`/vendor"

         ./vendor/bin/bundle --version
         ./vendor/bin/bundle install --gemfile=tests/browser/Gemfile --path vendor

         # Later on one can exec tests with:
         # GEM_PATH=`pwd`/bundle:`pwd`vendor ./bundle/bin/bundle  exec cucumber

# Pre setup the browsertests dependencies and craft a tarball
# for easy reuse. Meant to be run on post merge commit.
- job-template:
    name: 'qa-browsertests-postmerge'
    node: hasBrowserTests
    defaults: use-remote-zuul
    triggers:
     - zuul

    builders:
     - qa-browsertests-build
     - shell: |
         # Make a tarball for archiving
         GIT_COMMIT_SHORT=`git rev-parse --short HEAD`
         TAR_FILE="qa-browsertests-$BUILD_NUMBER-g$GIT_COMMIT_SHORT.tar.gz"
         tar -czf "$TAR_FILE" vendor tests/browser/.bundle

    publishers:
     - archive:
         artifacts: '*.tar.gz'

- job-template:
    name: 'qa-browsertests-build'
    node: hasBrowserTests
    defaults: use-remote-zuul
    triggers:
     - zuul
    builders:
     - qa-browsertests-build


# Should be a multi configuration job
#
# The job is not used because it takes too long and the tests fails under
# phantomjs anyway.
- job-template:
    name: 'qa-browsertests-run'
    node: hasBrowserTests
    defaults: use-remote-zuul
    triggers:
     - zuul
    builders:
     - qa-browsertests-build
     - shell: |
         # Publish some variables to env
         export BROWSER="phantomjs"
         export GEM_PATH=`pwd`/vendor
         mkdir -p logs/
         ./vendor/bin/bundle  exec cucumber --color \
            --format pretty \
            --format junit --out junit \
            --format html --out report.html

    publishers:
     - xunit:
         types:
          - junit:
              pattern: 'junit/*.xml'
     - archive:
         artifacts: 'report.html'


- project:
    name: 'qa-browsertests'

    jobs:
     - '{name}-ruby1.9.3lint'
     - '{name}-yamllint'
     - 'qa-browsertests-build'
     - 'qa-browsertests-postmerge'
     - 'qa-browsertests-run'
