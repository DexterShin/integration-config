# Contains any jobs related to the beta cluster.
#
# Beta is a cluster meant to reproduce the production environnement out of
# virtual instances in the Wikimedia labs.  We use Jenkins job to maintain
# some recurring tasks such as running the MediaWiki database schema updates.
#
# Jobs should be prefixed with 'beta-' and tied to the 'deployment-bastion'
# host defined in Jenkins.  They will run as the `jenkins-deploy` user on that
# instance.  To create a new job simply use the provided default which would
# take care of the basic configuration.
#
# Example:
#
#  - job:
#    name: beta-myawesomeness
#    defaults: beta
#

# Basic valid defaults, making sure we run on the deployment-bastion host
# slave nodes which is in labs.
- defaults:
    name: beta
    description: |
      <p>Job is managed by <a href="https://www.mediawiki.org/wiki/CI/JJB">Jenkins Job Builder</a>.</p>
    project-type: freestyle

    node: deployment-bastion

    wrappers:
      - timeout:
          timeout: 360
          fail: true
      - timestamps
      - ansicolor

- job:
    name: beta-update-databases
    defaults: beta

    project-type: matrix

    axes:
     - axis:
        type: label-expression
        name: label
        values:
         # deployment-bastion has the 'betacluster' label
         - betacluster
     - axis:
        type: user-defined
        name: wikidb
        values:
         - aawiki
         - commonswiki
         - dewiki
         - dewikivoyage
         - ee_prototypewiki
         - enwiki
         - enwikibooks
         - enwikinews
         - enwikiquote
         - enwikisource
         - enwikiversity
         - enwikivoyage
         - enwiktionary
         - eowiki
         - hewiki
         - labswiki
         - metawiki
         - simplewiki
         - sqwiki
         - testwiki
         - wikidatawiki

    builders:
     - shell: "sudo -u mwdeploy mwscript update.php --wiki=$wikidb --quick"

    triggers:
     - timed: '@hourly'

# On merge of mediawiki-config.git, checkout on beta
- job:
    name: beta-mediawiki-config-update
    defaults: use-zuul

    triggers:
     - zuul

    node: deployment-bastion

    scm:
        # Hack, remove the git scm from `use-zuul`. There is
        # no need to clone / fetch the repository.

    builders:
     # FIXME: this should probably be a shell script
     - shell: |
        # Shell out using sudo:
        #  -u : to user  mwdeploy
        #  -E : preserve environnement variables
        #  -H : set HOME to mwdeploy default home
        #  -s /bin/bash -c '': da hack
        #
        # InitialiseSettings.php need to be touched to update the config
        # cache on the Apaches instances.
        sudo -u mwdeploy -E -H -s /bin/bash -c '
          set -ex ;
          pwd ;
          cd /home/wikipedia/common ;
          pwd ;
          git remote update ;
          git reset --hard "$ZUUL_COMMIT" ;
          git tag "jenkins_build_$BUILD_NUMBER" "$ZUUL_COMMIT" ;
          touch /home/wikipedia/common/wmf-config/InitialiseSettings.php ;
         '
