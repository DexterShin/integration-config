- job-template:
    name: '{name}-{ext-name}-merge'
    defaults: use-zuul-for-mw-ext
    triggers:
     - zuul

- job-template:
    name: '{name}-{ext-name}-lint'
    defaults: use-zuul-for-mw-ext
    triggers:
     - zuul
    builders:
     - ant:
         targets: "php-lint"
         buildfile: "/var/lib/jenkins/jobs/_shared/build.xml"
         # The extension has been fetched in a workspace subdirectory
         # so make sure to lint the correct git working space
         properties:
             sourcedir: "$WORKSPACE/extensions/{ext-name}"

- job-template:
    name: '{name}-{ext-name}-whitespaces'
    default: use-zuul-for-mw-ext
    triggers:
     - zuul
    builders:
     - lint-whitespaces-in:
        dir: '$WORKSPACE/extensions/{ext-name}'

# Javascript linter is separated from the generic linter which let us finely
# tune on which extension Zuul will lint JavaScript.  The reason is that some
# extensions are not passing the tests yet.
# We will probably end up merging -jslint jobs with the -lint jobs.
- job-template:
    name: '{name}-{ext-name}-jslint'
    defaults: use-zuul
    scm:
     - git-mwext-in-root:
        ext-name: '{ext-name}'
    triggers:
     - zuul
    builders:
     - jshint
    publishers:
     - checkstyle-xml

- job-template:
    name: '{name}-{ext-name}-pep8'
    defaults: use-zuul-for-mw-ext
    triggers:
     - zuul
    builders:
     - pep8
    publishers:
     - pep8

- job-template:
    name: '{name}-{ext-name}-phpcs-HEAD'
    defaults: use-zuul
    scm:
     - git-mwext-in-root:
        ext-name: '{ext-name}'
    triggers:
     - zuul
    builders:
     - phpcs-HEAD
    publishers:
     - phpcs

# Run all extension tests
- job-template:
    name: '{name}-{ext-name}-testextensions-{mwbranch}'
    defaults: use-zuul-for-mw-ext
    triggers:
     - zuul
    builders:
     - get-mw-core:
        branch: '{mwbranch}'
     - mw-install-sqlite
     - mw-get-extensions:
         dependencies: '{dependencies}'
     - mw-configure-extensions
     - mw-run-update-script
     - mw-phpunit-ext:
        extension: '{ext-name}'
     - mw-phpunit-allexts
    # TODO, find ways to additionaly run tests for core but
    # without extensions tests
    publishers:
     - junit:
        results: 'junit*.xml'

- job-group:
    name: mwext-check-jobs
    jobs:
     - '{name}-{ext-name}-merge'
     - '{name}-{ext-name}-lint'
     - '{name}-{ext-name}-whitespaces'
     - '{name}-{ext-name}-jslint'
     - '{name}-{ext-name}-install'
     - '{name}-{ext-name}-testextensions-{mwbranch}'
     - '{name}-{ext-name}-phpcs-HEAD'

- project:
    name: mwext

    # By default we do not need any other extensions:
    dependencies: ""

    ext-name:
     - AbuseFilter
     - AdminLinks
     - Agora
     - APC
     - ApiSandbox
     - ArticleFeedbackv5
     - Ask
     - Babel
     - BlameMaps
     - CentralAuth
     - CentralNotice
     - CharInsert
     - CheckUser
     - cldr
     - CleanChanges
     - ConfirmEdit
     - ContributionScores
     - DataValues
     - DeleteBatch
     - Diff
     - DonationInterface
     - DumpHTML
     - E3Experiments
     - Echo
     - EducationProgram
     - EtherEditor
     - EventLogging
     - ExpandTemplates
     - Gadgets
     - GeoData
     - GettingStarted
     - GlobalBlocking
     - GoogleAdSense
     - GoogleCustomWikiSearch
     - GuidedTour
     - I18nTags
     - Interwiki
     - JsonData
     - LabeledSectionTransclusion
     - LiquidThreads
     - LocalisationUpdate
     - Maps
     - Math
     - MobileFrontend
     - MoodBar
     - MultiMaps
     - NewUserMessage
     - Nuke
     - OAI
     - OATHAuth
     - Offline
     - OpenID
     - OpenStackManager
     - PageTriage
     - ParserFunctions
     - ParserHooks
     - Parsoid
     - PHPExcel
     - Renameuser
     - ReplaceText
     - Score
     - Scribunto
     - SecurePoll
     - SemanticACL
     - SemanticBundle
     - SemanticCompoundQueries
     - SemanticDrilldown
     - SemanticExpressiveness
     - SemanticExtraSpecialProperties
     - SemanticForms
     - SemanticFormsInputs
     - SemanticGenealogy
     - SemanticGlossary
     - SemanticImageAnnotator
     - SemanticImageInput
     - SemanticInternalObjects
     - SemanticMaps
     - SemanticMediaWiki
     - SemanticPageMaker
     - SemanticPageSeries
     - SemanticResultFormats
     - SemanticSignup
     - SemanticTasks
     - SemanticTitle
     - SemanticUpdateOnPurge
     - SemanticWatchlist
     - SpamBlacklist
     - SVGEdit
     - SyntaxHighlight_GeSHi
     - TimedMediaHandler
     - TitleBlacklist
     - Translate
     - TranslationNotifications
     - UniversalLanguageSelector
     - UploadWizard
     - UserOptionStats
     - Validator
     - Vector
     - VisualEditor
     - WebChat
     - Wikibase
     - WikiEditor
     - WikiLexicalData
     - WikimediaMaintenance
     - WikimediaMessages
     - ZeroRatedMobileAccess

    mwbranch:
     - master
     - REL1_20
     - REL1_19

    jobs:
     - mwext-check-jobs

    # FIXME: this really need to be improved :(
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: Wikibase
        dependencies: 'Ask,Diff,DataValues,Validator'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: Ask
        dependencies: 'DataValues'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: EducationProgram
        dependencies: 'cldr'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: Maps
        dependencies: 'DataValues,Validator'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: SemanticMaps
        dependencies: 'DataValues,Validator,SemanticMediaWiki,Maps'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: SemanticResultFormats
        dependencies: 'DataValues,Validator,SemanticMediaWiki'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: SemanticMediaWiki
        dependencies: 'DataValues,Validator'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: TranslationNotifications
        dependencies: 'Translate'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: Validator
        dependencies: 'DataValues'

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: BlameMaps

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: ConfirmEdit

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: DumpHTML

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: EventLogging

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: Offline

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: OpenStackManager

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: SemanticBundle

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: SemanticResultFormats

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: WikimediaMaintenance
