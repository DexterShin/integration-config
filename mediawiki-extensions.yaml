- job-template:
    name: '{name}-{ext-name}-merge'
    defaults: use-zuul-for-mw-ext
    triggers:
     - zuul

- job-template:
    # TODO: Use global '{name}-phplint' template instead
    name: '{name}-{ext-name}-lint'
    node: hasSlaveScripts
    defaults: use-zuul
    scm:
     - git-mwext-in-root:
        ext-name: '{ext-name}'
    triggers:
     - zuul
    builders:
     - phplint

- job-template:
    name: '{name}-{ext-name}-whitespaces'
    defaults: use-zuul-for-mw-ext
    triggers:
     - zuul
    builders:
     - lint-whitespaces-in:
        dir: '$WORKSPACE/extensions/{ext-name}'

# jshint is in a separate job from phplint because various extensions
# don't pass jshint yet but do pass phplint. This way we can opt-in
# on a project base.
- job-template:
    name: '{name}-{ext-name}-jslint'
    defaults: use-zuul
    scm:
     - git-mwext-in-root:
        ext-name: '{ext-name}'
    triggers:
     - zuul
    builders:
     - jshint

- job-template:
    name: '{name}-{ext-name}-qunit'
    node: hasSlaveScripts
    defaults: use-zuul-for-mw-ext
    triggers:
     - zuul

    builders:
     - mw-setup-extension:
        mwbranch: 'master'
        dependencies: '{dependencies}'
     - qunit

- job-template:
    name: '{name}-{ext-name}-pep8'
    defaults: use-zuul-for-mw-ext
    triggers:
     - zuul
    builders:
     - pep8
    publishers:
     - pep8

- job-template:
    name: '{name}-{ext-name}-phpcs-HEAD'
    node: hasSlaveScripts
    defaults: use-zuul
    scm:
     - git-mwext-in-root:
        ext-name: '{ext-name}'
    triggers:
     - zuul
    builders:
     - phpcs-HEAD
    publishers:
     - phpcs

# Run all extension tests
- job-template:
    name: '{name}-{ext-name}-testextensions-{mwbranch}'
    node: hasSlaveScripts
    defaults: use-zuul-for-mw-ext
    triggers:
     - zuul
    builders:
     - mw-setup-extension:
        mwbranch: '{mwbranch}'
        dependencies: '{dependencies}'
     - mw-phpunit-allexts
    # TODO, find ways to additionaly run tests for core but
    # without extensions tests
    publishers:
     - junit:
        results: 'junit*.xml'

# Job specific to Wikibase, let us switch between client
# and server configurations.
- job-template:
    name: 'mwext-Wikibase-{kind}-tests'
    node: hasSlaveScripts
    defaults: use-zuul-for-mw-ext
    ext-name: 'Wikibase'
    triggers:
     - zuul
    builders:
     - mw-setup-extension:
        mwbranch: 'master'
        dependencies: '{dependencies}'
     - mw-phpunit-allexts
    publishers:
     - junit:
        results: 'junit*.xml'


# VisualEditor's docgen has a maintenance script, so install mediawiki first
- job-template:
    name: 'mwext-VisualEditor-doc-test'
    defaults: use-zuul-for-mw-ext
    triggers:
     - zuul
    builders:
     - mw-setup-extension:
        mwbranch: '{mwbranch}'
        dependencies: '{dependencies}'
     - shell: |
        export TERM=xterm
        $WORKSPACE/extensions/VisualEditor/.docs/generate.sh

- job-template:
    name: 'mwext-VisualEditor-doc-publish'
    node: gallium
    defaults: use-zuul-for-mw-ext
    triggers:
     - zuul
    builders:
     - mw-setup-extension:
        mwbranch: '{mwbranch}'
        dependencies: '{dependencies}'
     - shell: |
        # Generate documentation
        $WORKSPACE/extensions/VisualEditor/.docs/generate.sh --ve-path="modules/"
        # Set destination and version directory therein
        DEST_DIR="/srv/org/wikimedia/doc/VisualEditor"
        DEST_VERSIONDIR=`echo "$GERRIT_BRANCH" | tr '/' '-'`
        # Ensure the destination exists
        mkdir -p $DEST_DIR
        # Publish it (trailing slash is important!)
        rsync --recursive --delete-after --force $WORKSPACE/extensions/VisualEditor/docs/ "$DEST_DIR/$DEST_VERSIONDIR/"
        rsync --recursive --delete-after --force $WORKSPACE/extensions/VisualEditor/modules/ "$DEST_DIR/$DEST_VERSIONDIR/modules/"

# These are jobs we create for all of the extensions
# listed below. If a job should only be created
# for a select number of extensions or if it needs
# custom parameters, add it below under "Extra jobs for specific extensions"
# at the bottom of this file.
- job-group:
    name: mwext-check-jobs
    jobs:
     - '{name}-{ext-name}-merge'
     - '{name}-{ext-name}-lint'
     - '{name}-{ext-name}-whitespaces'
     - '{name}-{ext-name}-jslint'
     - '{name}-{ext-name}-install'
     - '{name}-{ext-name}-testextensions-{mwbranch}'
     - '{name}-{ext-name}-phpcs-HEAD'

- project:
    name: mwext

    # By default we do not need any other extensions:
    dependencies: ""

    ext-name:
     - AbuseFilter
     - ActiveAbstract
     - AdminLinks
     - Agora
     - Annotator
     - AntiBot
     - AntiSpoof
     - AntiSpoof
     - APC
     - ApiSandbox
     - ApprovedRevs
     - Arrays
     - ArticleFeedbackv5
     - Ask
     - Babel
     - BlameMaps
     - BookManager
     - Calendar
     - Campaigns
     - CategoryTree
     - CentralAuth
     - CentralNotice
     - CharInsert
     - CheckUser
     - CirrusSearch
     - Cite
     - cldr
     - CleanChanges
     - ClickTracking
     - ClientSide
     - CodeEditor
     - CodeReview
     - Collection
     - CommunityApplications
     - CommunityHiring
     - CommunityVoice
     - Configure
     - ConfirmEdit
     - ContactPage
     - ContactPageFundraiser
     - ContributionReporting
     - ContributionScores
     - ContributionTracking
     - CoreEvents
     - CreditsSource
     - CustomData
     - CustomUserSignup
     - DataValues
     - DeleteBatch
     - Diff
     - DisableAccount
     - Disambiguator
     - DiscussionThreading
     - DismissableSiteNotice
     - DonationInterface
     - DoubleWiki
     - DumpHTML
     - DynamicSidebar
     - E3Experiments
     - Echo
     - Editcount
     - EditPageTracking
     - EducationProgram
     - EmailCapture
     - EtherEditor
     - EventLogging
     - ExpandTemplates
     - ExtensionDistributor
     - FeaturedFeeds
     - FormPreloadPostCache
     - Foxway
     - FundraiserLandingPage
     - Gadgets
     - GeoCrumbs
     - GeoData
     - GettingStarted
     - GlobalBlocking
     - GlobalUsage
     - GoogleAdSense
     - GoogleCustomWikiSearch
     - GoogleNewsSitemap
     - GoogleSiteSearch
     - GuidedTour
     - I18nTags
     - ImageMap
     - InputBox
     - Insider
     - intersection
     - Interwiki
     - JsonData
     - LabeledSectionTransclusion
     - LandingCheck
     - LastModified
     - LdapAuthentication
     - Lingo
     - LinkedWiki
     - LiquidThreads
     - Listings
     - LocalisationUpdate
     - Maps
     - MapSources
     - MarkAsHelpful
     - Math
     - MobileFrontend
     - MoodBar
     - MultiMaps
     - MwEmbedSupport
     - MWSearch
     - Narayam
     - NaturalLanguageList
     - NavigationTiming
     - NewestPages
     - NewUserMessage
     - NewUserNotif
     - Nonlinear
     - Nuke
     - OAI
     - OATHAuth
     - Offline
     - OpenID
     - OpenSearchXml
     - OpenStackManager
     - PagedTiffHandler
     - PageImages
     - PageTriage
     - ParserFunctions
     - ParserHooks
     - Parsoid
     - PdfHandler
     - PHPExcel
     - Poem
     - PoolCounter
     - PostEdit
     - ProofreadPage
     - Quiz
     - RandomRootPage
     - ReaderFeedback
     - RelatedArticles
     - RelatedSites
     - Renameuser
     - ReplaceSet
     - ReplaceText
     - RSS
     - Score
     - Scribunto
     - SearchExtraNS
     - SecurePoll
     - SemanticACL
     - SemanticBundle
     - SemanticCompoundQueries
     - SemanticDrilldown
     - SemanticExpressiveness
     - SemanticExtraSpecialProperties
     - SemanticForms
     - SemanticFormsInputs
     - SemanticGenealogy
     - SemanticGlossary
     - SemanticImageAnnotator
     - SemanticImageInput
     - SemanticInternalObjects
     - SemanticMaps
     - SemanticMediaWiki
     - SemanticPageMaker
     - SemanticPageSeries
     - SemanticResultFormats
     - SemanticSignup
     - SemanticTasks
     - SemanticTitle
     - SemanticUpdateOnPurge
     - SemanticWatchlist
     - Serialization
     - ShortUrl
     - SimpleAntiSpam
     - SiteMatrix
     - SkinPerPage
     - skins
     - SlippyMap
     - Solarium
     - SpamBlacklist
     - StrategyWiki
     - SubPageList3
     - SubpageSortkey
     - Sudo
     - Survey
     - SVGEdit
     - SwiftCloudFiles
     - SyntaxHighlight_GeSHi
     - TemplateData
     - TemplateSandbox
     - Thanks
     - TimedMediaHandler
     - timeline
     - TitleBlacklist
     - TitleKey
     - TocTree
     - TorBlock
     - Translate
     - TranslationNotifications
     - Transliterator
     - TrustedXFF
     - TwnMainPage
     - UnicodeConverter
     - UniversalLanguageSelector
     - UploadBlacklist
     - UploadWizard
     - UserDailyContribs
     - UserMerge
     - UserOptionStats
     - UserThrottle
     - Validator
     - Variables
     - Vector
     - VipsScaler
     - VisualEditor
     - WebChat
     - WebFonts
     - Wikibase
     - WikibaseDatabase
     - WikibaseDataModel
     - WikibaseQuery
     - WikibaseQueryEngine
     - WikiEditor
     - wikihiero
     - WikiLexicalData
     - WikiLove
     - WikimediaIncubator
     - WikimediaMaintenance
     - WikimediaMessages
     - WikimediaShopLink
     - ZeroRatedMobileAccess

    mwbranch:
     - master
# Commented out since they are not triggered for now.
#     - REL1_21
#     - REL1_20
#     - REL1_19

    jobs:
     - mwext-check-jobs

    # Extra jobs for specific extensions

     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: Wikibase
        dependencies: 'Ask,Serialization,Diff,DataValues,WikibaseDataModel,Validator'
     - 'mwext-Wikibase-{kind}-tests':
        ext-name: Wikibase
        dependencies: 'Ask,Serialization,Diff,DataValues,WikibaseDataModel,Validator'
        kind: 'client'
     - 'mwext-Wikibase-{kind}-tests':
        ext-name: Wikibase
        dependencies: 'Ask,Serialization,Diff,DataValues,WikibaseDataModel,Validator'
        kind: 'repo'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        ext-name: WikibaseDataModel
        dependencies: 'Diff,DataValues'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        ext-name: WikibaseDatabase
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        ext-name: WikibaseQueryEngine
        dependencies: 'Diff,DataValues,Ask,Serialization,WikibaseDataModel,WikibaseDatabase'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        ext-name: WikibaseQuery
        dependencies: 'Diff,DataValues,Ask,Serialization,WikibaseDataModel,WikibaseDatabase,WikibaseQueryEngine,Wikibase'

     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: Ask
        dependencies: 'Serialization,DataValues'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: EducationProgram
        dependencies: 'cldr'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: GuidedTour
        dependencies: 'EventLogging'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: Maps
        dependencies: 'DataValues,Validator'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: SemanticMaps
        dependencies: 'DataValues,Validator,SemanticMediaWiki,Maps'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: SemanticResultFormats
        dependencies: 'DataValues,Validator,SemanticMediaWiki'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: SemanticMediaWiki
        dependencies: 'DataValues,Validator,Scribunto'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: TranslationNotifications
        dependencies: 'Translate'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: Validator
        dependencies: 'DataValues'
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: Serialization
     - '{name}-{ext-name}-testextensions-{mwbranch}':
        name: mwext
        ext-name: ParserHooks
        dependencies: 'DataValues,Validator'

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: BlameMaps

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: ConfirmEdit

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: DumpHTML

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: EventLogging

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: Offline

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: OpenStackManager

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: SemanticBundle

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: SemanticResultFormats

     - '{name}-{ext-name}-pep8':
        name: mwext
        ext-name: WikimediaMaintenance

     # qunit jobs for MediaWiki extensions

     - '{name}-{ext-name}-qunit':
        name: mwext
        ext-name: EventLogging

     - '{name}-{ext-name}-qunit':
        name: mwext
        ext-name: GuidedTour
        dependencies: 'EventLogging'

     - '{name}-{ext-name}-qunit':
        name: mwext
        ext-name: MobileFrontend

     - '{name}-{ext-name}-qunit':
        name: mwext
        ext-name: VisualEditor


     - 'mwext-VisualEditor-doc-test':
        ext-name: VisualEditor

     - 'mwext-VisualEditor-doc-publish':
        ext-name: VisualEditor

- project:
    name: 'mwext-MobileFrontend'
    gerrit-name: mediawiki/extensions/MobileFrontend
    jobs:
     - '{name}-ruby1.9.3lint'

- job-template:
    name: 'mwext-PoolCounter-build'
    defaults: use-zuul
    triggers:
     - zuul
    builders:
     - shell: |
        cd daemon
        make

- project:
    name: 'mwext-PoolCounter'
    gerrit-name: mediawiki/extensions/PoolCounter
    jobs:
     - 'mwext-PoolCounter-build'

- project:
    name: 'mwext-timeline'
    gerrit-name: mediawiki/extensions/timeline
    jobs:
     - '{name}-perllint'
